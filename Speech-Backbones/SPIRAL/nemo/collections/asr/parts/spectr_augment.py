# 2020.03.04 make the following changes:
#            - support adaptive SpecAug
#            - support gaussian mask for SpecAug
#            - support target shifting, gaussian mask
#            Huawei Technologies Co., Ltd. <foss@huawei.com>
# Copyright (C) 2022. Huawei Technologies Co., Ltd. All rights reserved.
#
#
# Copyright (c) 2020, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import random

import torch
import torch.nn as nn


GAUSSIAN_MASK = [-0.008577285334467888, -0.008312131278216839, -0.003433679463341832, -0.007991528138518333, 0.022046754136681557, -0.014587175101041794, 0.010684879496693611, 0.0032962223049253225, 0.0006217826739884913, -0.0109024653211236, 0.003951661288738251, 0.006253963336348534, 0.005004990380257368, -0.004416681360453367, -0.014572846703231335, -0.006137363612651825, 0.015708647668361664, 0.013687868602573872, -0.0034236200153827667, -0.017063571140170097, -0.005857351701706648, 0.00830098520964384, 0.001996119972318411, 0.0001801295584300533, 0.007846095599234104, 0.006822641938924789, 0.0053718010894954205, -0.006921472027897835, -0.008087077178061008, 0.0019816632848232985, 0.017332371324300766, 0.0013035658048465848, -0.005086318589746952, 0.0038084506522864103, -0.0028235530480742455, 0.004277005326002836, -0.008790107443928719, -0.01645108126103878, -0.00870309118181467, 0.0030529664363712072, 0.0044243973679840565, -0.001729264622554183, 0.0018796413205564022, 0.001113063539378345, 0.001685396651737392, 0.007856708019971848, -0.008503658697009087, 0.004928226582705975, 0.003501072758808732, 0.013370650820434093, 0.015068281441926956, -0.008089980110526085, -0.00913938321173191, 0.010570412501692772, -0.0008485731086693704, -0.0017308632377535105, 0.009554422460496426, 0.0008375696488656104, 0.01573362946510315, -0.00033936771797016263, -0.00738796591758728, 0.004305792506784201, 0.01625652238726616, 0.004601571708917618, 0.0033054756931960583, -0.006255044601857662, -0.004542464856058359, 0.013747476041316986, -0.010799456387758255, 0.0024993526749312878, 0.005865572020411491, -0.013002256862819195, 0.005194664001464844, -0.021207045763731003, 0.007146795745939016, 0.001368773402646184, -0.014667760580778122, 0.010809154249727726, -0.005281668156385422, 0.009397738613188267, -0.0117409098893404, 0.010593295097351074, 0.00379750388674438, 0.005227712448686361, 0.005195990204811096, 0.007941234856843948, -0.008073929697275162, 0.0005659427843056619, -0.002949729096144438, 0.004707518499344587, 0.00013310337089933455, -0.0021645540837198496, 0.005021876189857721, 0.006173995789140463, 0.007487660273909569, 0.00892797950655222, 0.008880391716957092, 0.017241517081856728, 0.007244352716952562, -0.0020703296177089214, -0.003922614734619856, -0.017371725291013718, 0.0036656244192272425, 0.0008915121434256434, -0.010720319114625454, -0.0029386195819824934, -0.004162450321018696, -0.003555792849510908, -0.009222142398357391, 0.008136272430419922, -0.016355125233530998, -0.0019096146570518613, 0.009561257436871529, -0.0009358802926726639, -0.009368732571601868, -0.0006803714786656201, -0.0032679459545761347, -0.010729965753853321, -0.006920733489096165, -0.007359025534242392, -0.0036679436452686787, -0.01085688453167677, 0.0032564126886427402, -0.00396075751632452, 0.003947695717215538, 0.006906456314027309, -0.00874226726591587, -0.010531643405556679, 0.002544721122831106, 0.003992108628153801, 0.002931957133114338, -0.008593415841460228, -0.00834380928426981, -0.0004008698451798409, -0.007474125362932682, -0.0018838047981262207, -0.010623954236507416, 0.0004698234552051872, -0.0064691524021327496, -0.001641935552470386, 0.030333172529935837, 0.01937473751604557, 0.008528976701200008, -0.015279320999979973, -0.009957612492144108, 0.004345834255218506, 0.0052221533842384815, 0.028346601873636246, 0.00015258256462402642, 0.017097460106015205, -0.011207249946892262, -0.0013319909339770675, -0.01574462465941906, -0.001186217530630529, 0.002741827629506588, -0.0027266093529760838, -0.0019425811478868127, -0.016291635110974312, 0.0014635918196290731, -0.0068401917815208435, -0.0023575483355671167, -0.023059917613863945, -0.004130368120968342, 0.018156377598643303, -0.010979206301271915, 0.0030661290511488914, 0.001635069027543068, -0.013064907863736153, -0.0013261985732242465, 0.008750525303184986, 0.01025752630084753, 0.006366524379700422, -0.019202180206775665, 0.012242366559803486, 0.005239878781139851, 0.006112856324762106, -0.0009505008929409087, 0.007498623337596655, 0.004345917142927647, 0.0019737775437533855, 0.01724175363779068, -0.011013401672244072, 0.01421738788485527, -0.00010386518988525495, 0.0005218135192990303, -7.810740498825908e-05, -0.0013396443100646138, 0.00891269650310278, 0.006826599128544331, -0.005983854178339243, -0.008014648221433163, -0.004054467659443617, 0.003911960404366255, 0.012865566648542881, 0.006723911035805941, 0.00459368946030736, 0.008541394025087357, 0.014683294110000134, 0.017786560580134392, -0.006093125324696302, 0.0011138939298689365, 0.005661547649651766, -0.001207416644319892, -0.008716529235243797, 0.004718406591564417, -0.004078548867255449, 0.004175822716206312, -0.007703948300331831, 0.01632404327392578, -0.00023797148605808616, 0.0023386836983263493, 0.0049704634584486485, 0.01812780275940895, 0.008168922737240791, -0.01889769174158573, -0.007803930900990963, 0.004977164324373007, 0.005988257005810738, -0.0024359619710594416, 0.015691304579377174, -0.004170612432062626, 0.011284936219453812, -0.012687956914305687, -0.013468815013766289, -0.0056364708580076694, 0.003777650184929371, -0.010477692820131779, -3.670304431580007e-05, 0.002994526643306017, -0.02478531375527382, -0.0186957735568285, -0.000980377197265625, -0.006090754177421331, -0.0008337362669408321, 0.0042216661386191845, -0.0017890859162434936, -0.017191831022500992, 0.007558343932032585, -0.0004839670436922461, 0.0006820259150117636, -0.0036172219552099705, 0.012755093164741993, 0.007131294813007116, 0.01682445965707302, -0.0033714391756802797, 0.011848727241158485, -0.008541670627892017, 0.005448013544082642, 0.005193810444325209, 0.0003855297400150448, 0.009456363506615162, -0.004641769919544458, 0.025975538417696953, -0.008149398490786552, -0.014135519042611122, 0.006781088653951883, 0.004117966629564762, -0.006494637578725815, -0.007128587923943996, 0.006647801958024502, -0.012087219394743443, 0.001748546026647091, 0.01748277060687542, -0.004554575774818659, 0.0036450892221182585, -0.010104892775416374, -0.0035864445380866528, 0.0058875922113657, -0.0011381434742361307, 0.0015288969734683633, 0.0013207353185862303, -0.003274752525612712, 0.0023052070755511522, -0.011285059154033661, 0.011404736898839474, -0.001985494513064623, -0.008716653101146221, 0.005484268069267273, -0.0021095615811645985, 0.015584509819746017, -0.008399765007197857, 0.007663742173463106, -0.0046447026543319225, 0.01980607770383358, -0.021430866792798042, 0.0019235932268202305, 0.01850181445479393, 0.014331997372210026, 0.004704942926764488, -0.004087083041667938, -0.0052873240783810616, -0.004040342289954424, -0.0009587344247847795, -0.001312632579356432, 0.006471287924796343, -0.004858402069658041, 0.006215596571564674, -0.01835842989385128, -0.013215125538408756, -0.012908847071230412, -0.005191713571548462, 0.005219723097980022, -0.0015103589976206422, -0.006740736309438944, -0.005966144613921642, -0.0008368652779608965, 0.003591155633330345, -0.0025086551904678345, 0.018543150275945663, 0.01635683700442314, 0.003782284678891301, -0.012239447794854641, 0.0011241791071370244, -8.145845640683547e-05, 0.01495729386806488, 0.0033017871901392937, 0.00019223176059313118, 0.007682753726840019, 0.011071891523897648, 0.011146822944283485, -0.006912447512149811, 0.0034845354966819286, 0.005456835497170687, 0.002649294678121805, -0.005829342640936375, -0.002240463625639677, 0.0029810150153934956, 0.0026485121343284845, 0.012740016914904118, 0.006942421197891235, 0.008712748065590858, -0.002921474166214466, -0.003271800698712468, -0.0006888209609314799, 0.000602235842961818, -0.009740591049194336, -0.005469066556543112, 0.0027335130143910646, -0.007446215022355318, -0.010410390794277191, -0.020527798682451248, -0.0007794187986291945, -0.010217029601335526, -0.008854899555444717, 0.0018076488049700856, 0.003745997091755271, -0.008995960466563702, 0.006499497219920158, -0.009520279243588448, -0.0013822759501636028, 0.005432894919067621, 0.0048836348578333855, -0.006969304755330086, 0.009624844416975975, 0.002221961971372366, 0.012857971712946892, 0.00029701043968088925, 0.01846439018845558, -0.0010167461587116122, 0.003362444229424, 0.018802843987941742, 0.007899937219917774, 0.007362710777670145, -0.01259714737534523, -0.004353848285973072, 0.009529988281428814, -0.010434559546411037, -0.00114968151319772, -0.015083436854183674, -0.000513288367073983, -0.012708902359008789, 0.009817283600568771, -0.01616625115275383, 0.02099389024078846, 0.0011255480349063873, 0.002087818691506982, 0.004141946788877249, -0.004236323293298483, -0.008043688721954823, -0.01005634292960167, -0.01211725827306509, 0.008502005599439144, -0.003608573926612735, 0.0013564183609560132, 0.0025668770540505648, 0.006136550568044186, 0.01201977115124464, 0.025350334122776985, 0.012129077687859535, -0.0032070353627204895, 0.0003363523574080318, -0.00036432372871786356, 6.168012623675168e-05, -0.010630798526108265, -0.001909107668325305, 0.0031751287169754505, 0.023505495861172676, 0.006265965756028891, -0.000127899824292399, 0.027016283944249153, -0.003139286069199443, 0.007756243925541639, 0.012871683575212955, -0.005639276001602411, 0.006201721262186766, -0.007926560938358307, -0.007784618530422449, 0.0018705694237723947, 0.011534891091287136, 0.003263025777414441, -0.008872064761817455, 0.011395181529223919, -0.0061043002642691135, -0.0020404469687491655, -0.002608739770948887, 0.0014213520335033536, 7.451167039107531e-05, -0.0006841712747700512, 0.00638044998049736, 0.02477930672466755, -0.0001436929014744237, 0.009057887829840183, -0.0005273017450235784, -0.016813546419143677, -0.011913691647350788, 0.008906804956495762, 0.0009794242214411497, -0.002302555600181222, 0.012043703347444534, -0.00899094995111227, 0.0017951279878616333, 0.010412560775876045, -0.0018607425736263394, 0.003462078981101513, 0.010766361840069294, 0.007733880076557398, 0.0037096040323376656, 0.013803163543343544, -0.010908039286732674, 0.012310138903558254, 0.011781050823628902, -0.022002901881933212, 0.01713118888437748, 0.004179463256150484, 0.00031042384216561913, 0.002601897343993187, 0.002513417275622487, -0.0009618049371056259, 0.0004392332921270281, -0.01457865722477436, -0.00014599964197259396, -0.016580622643232346, -0.014996372163295746, 0.0037527403328567743, -0.008046748116612434, 0.0020090779289603233, -0.0033000593539327383, 0.0052381521090865135, 0.001489385380409658, -0.010585324838757515, -0.015648989006876945, -0.0017674925038591027, 0.004076640121638775, 0.019764112308621407, -0.010859061032533646, -0.0004517346096690744, 0.019380798563361168, -0.0069849626161158085, 0.006805767305195332, 0.0010639704996719956, -0.0008604522445239127, 0.014004685916006565, -0.009115546941757202, 0.020015710964798927, 0.0020416032057255507, -0.005136480089277029, -0.014490129426121712, -0.013324854895472527, 0.02655731327831745, -0.006656433921307325, -0.003929227590560913, 0.0036637713201344013, -0.002843528985977173, 0.016735395416617393, -0.0026499521918594837, -9.097589645534754e-05, 0.0009586272644810379, -0.008444109931588173, -0.01267432514578104, -0.00987020693719387, 0.024359915405511856, 0.006355916149914265, -0.010813186876475811, -0.008563755080103874, 0.001825400278903544, 0.015858624130487442, 0.008124123327434063, 0.007248807232826948, 0.0014658113941550255, 0.00889967568218708, -0.018838992342352867, 0.012073985300958157, 0.007954470813274384, 0.0040962728671729565, 0.003913100343197584, -0.009089702740311623, -0.01628614217042923, -0.005144990514963865, 0.006413666065782309, -0.014760496094822884, -0.010384202003479004, -0.013040153309702873, 0.018687430769205093, -0.0015114899724721909, -0.007259591482579708, -0.002887800568714738, 0.01662031002342701, 0.01137789711356163, 0.0007028636755421758, 0.004064011387526989, 0.007000538054853678, -0.005053787026554346, 0.012506005354225636, -0.009795127436518669, 0.0013481989735737443, 0.01153571903705597, 0.0005770407733507454, 0.00843889731913805, -0.004305741284042597, -0.00523682776838541, -0.003950543235987425, -0.030804451555013657, 0.0019242960261180997, -0.001121998648159206, -0.00024091487284749746, -0.011150459758937359, -0.0006252250750549138, -0.008173838257789612, 0.0025749732740223408, 0.012828282080590725, 0.0037352831568568945, 0.017000781372189522, 0.019764423370361328, -0.006141415797173977, 0.009571244940161705, 0.0060485838912427425, -0.003701487323269248, 0.012796318158507347, -0.005578612443059683, -0.002949218498542905, -0.0077390591613948345, 0.013134066946804523, 0.01348984893411398, -0.017807014286518097, -0.007176446728408337, -0.0025080926716327667, 0.0026706154458224773, 0.006270487792789936, -0.001722719520330429, 0.014065185561776161, -0.012098010629415512, -0.006948764901608229, 0.007107093930244446, 0.011564299464225769, 0.015365575440227985, -0.001405196264386177, 0.013922395184636116, -0.011645046062767506, 0.019185440614819527, 0.008669205941259861, -0.006402950268238783, -0.02930634282529354, 0.012674490921199322, 0.0020986138842999935, 0.0073446049354970455, -0.008211275562644005, -0.010451032780110836, 0.0039263502694666386, 0.010214317589998245, 0.005137004889547825, 0.003445018082857132, 0.011561079882085323, 0.014101037755608559, -0.0009882557205855846, -0.020502908155322075, -0.01304234005510807, -0.0010743135353550315, 0.006024991162121296, 0.005487101152539253, 0.015423699282109737, 0.010340548120439053, 0.007406091317534447, -0.002593359677121043, -0.014484986662864685, -0.008927910588681698, 0.01809288188815117, -8.335654797519965e-07, 0.016086341813206673, -0.007467319723218679, 0.006248668301850557, 0.010234993882477283, 0.01105313841253519, 0.017129629850387573, 0.01001526229083538, 0.008971969597041607, 0.0019335917895659804, 0.014964735135436058, 0.0032235209364444017, -0.01558700855821371, -0.0002231745602330193, 1.0325457878934685e-05, 0.005610847380012274, -0.0014725240180268884, -0.007073611952364445, 0.006045978516340256, 0.00661000469699502, 0.016458045691251755, 0.004776420537382364, -0.0024809655733406544, -0.001141632441431284, 0.020380591973662376, 0.001985315466299653, 0.0016066418029367924, -0.0002630813978612423, -0.0023715763818472624, -0.005043766926974058, -0.0006530124810524285, -0.0011994787491858006, -0.005200596526265144, -0.011772070080041885, 0.020897328853607178, -0.0030809161253273487, 0.0151188550516963, -0.002648375928401947, -0.0020464551635086536, -0.011824622750282288, 0.006495086010545492, -0.006923593580722809, -0.010816085152328014, -0.0005119291599839926, 0.019806137308478355, 0.01142488420009613, 0.006749970838427544, -0.015500311739742756, -0.00845906138420105, -0.0021400016266852617, -0.0008869305020198226, 0.016512639820575714, 0.0022560760844498873, -0.003913175780326128, 0.007876270450651646, 0.0010393362026661634, 0.009496960788965225, 0.008087781257927418, 0.0075989654287695885, 0.007650574669241905, 0.011847944930195808, 0.006889567244797945, 0.005724477581679821, 0.003269805572926998, 0.017861217260360718, 0.014128664508461952, -0.018311243504285812, -0.00034174948814325035, 0.010595879517495632, -0.007073213811963797, -0.0037547526881098747, 0.007721452973783016, -0.013909009285271168, 0.009047291241586208, -0.005391568876802921, 0.010471170768141747, -0.005925311706960201, -0.010769817978143692, -0.01213113870471716, 0.013672600500285625, -0.025970296934247017, 0.004848531447350979, -3.2736243156250566e-05, -0.0014015173073858023, -0.006384227890521288, 0.00352313625626266, 0.007666777819395065, 0.011333705857396126, -0.02562958188354969, 0.007899546064436436, -0.0003998324682470411, 0.00041209004120901227, 0.003894905559718609, 0.011146043427288532, 0.012012973427772522, 0.005776166915893555, 0.01267810445278883, 0.015597822144627571, -0.006004557479172945, -0.005119791720062494, 0.004542575217783451, -0.006028160918504, 0.0002760722709354013, 0.008363571017980576, 0.004950536414980888, 0.006884160451591015, 0.002470653271302581, 0.008553436025977135, 0.016060978174209595, -0.004487414378672838, 0.0008720596670173109, -0.0011375041212886572, 0.006429357919842005, -0.014677043072879314, 0.011124462820589542, -0.0023991605266928673, -0.003062682691961527, -0.0004514633328653872, 0.007666073273867369, 0.008637756109237671, -0.009318140335381031, 0.017036888748407364, -0.001699244137853384, -0.001919509842991829, -0.010616443119943142, -0.014744545333087444, 0.0023425209801644087, 0.015598481521010399, 0.004587096627801657, -0.006646877154707909, -0.0003353591891936958, 0.018362227827310562, -0.0008180644363164902, -0.009953021071851254, 0.009997352957725525, 0.006935094483196735, -0.0041261701844632626, 0.008880453184247017, 0.014008709229528904, -0.002823092043399811, 0.00992603413760662, -0.012414450757205486, 0.00843184906989336, 0.0020578710827976465, 0.016727814450860023, 0.019950158894062042, -0.004741964861750603, -0.0005425591953098774, -0.0058597358874976635, -0.0017816543113440275, 0.0027736839838325977, -0.012360996566712856, 0.003590812673792243, 0.005126148462295532, 0.004654150456190109, -0.006369463168084621, -0.003772721393033862, 0.02091693878173828, 0.01528538204729557, -0.003835881594568491, -0.003409450873732567, 0.010528912767767906, -0.0017828766722232103, 0.02516132965683937, 0.00814846158027649, -0.004559976980090141, -0.011295965872704983, 0.010371438227593899, 0.0006707622087560594, 0.005064355209469795, -0.010145595297217369, 0.004426772706210613, -0.005737415049225092, 0.0012003653682768345, 0.0036150291562080383, 0.011215592734515667, -0.0040545896627008915, 0.0034540158230811357, -0.008764381520450115, 0.014239713549613953, -0.0008067164453677833, -0.0077876923605799675, -0.018948623910546303, 0.003514879383146763, 0.0030799901578575373, 0.017965681850910187, -2.2737660401617177e-05, 0.007884345017373562, 0.003565009217709303, -0.012896131724119186, 0.0026204099413007498, -0.0020277798175811768, -0.005030298605561256, 0.0028232778422534466, -0.010799753479659557, 0.0004869748081546277, 0.00079371128231287, 0.0038255134131759405, 0.01625426858663559, -0.007327786646783352, -0.0006097709410823882, 0.021006541326642036, -0.004630157724022865, -0.015508498065173626, -0.011421660892665386, 0.004675465635955334, -0.0020752830896526575, 0.00651256600394845, -0.001388593576848507, -0.018634997308254242, -0.013168826699256897, 0.00600035535171628, -0.0051271733827888966, -0.0009046715567819774, 0.008201603777706623, 0.004723501857370138, -0.003945730160921812, 0.002696358598768711, -0.00534584978595376, 0.014200250618159771, 0.0032823574729263783, -0.009708631783723831, -0.002968631684780121, -0.0013192173792049289, -0.02307787910103798, 0.0048147342167794704, 0.009474620223045349, 0.0016143537359312177, 0.0026406359393149614, -0.004522481467574835, -0.00021635316079482436, 0.003252497175708413, -0.012805595062673092, 0.0034197745844721794, -0.016244668513536453, 0.001594359870068729, 0.01458613108843565, 0.010125475935637951, -0.009164906106889248, 0.006422918755561113, 0.002428187755867839, -0.005929546430706978, -0.012289043515920639, -0.00899637583643198, 6.348137685563415e-05, 0.01821526326239109, -0.0014832826564088464, -0.010244476608932018, -0.0010153147159144282, -0.005283149890601635, -0.012473183684051037, 0.007026445120573044, -0.011461296118795872, 0.0033159609884023666, -0.01289116870611906, 0.01181294210255146, 0.012677633203566074, -0.0013208106392994523, 0.003216641489416361, -0.012547919526696205, 0.004124876111745834, 0.0009470342774875462, -0.002027716487646103, 0.02221308834850788, -0.0008846950950101018, -0.0014873967738822103, 0.0159499179571867, 0.006823782809078693, -0.014584256336092949, -0.008290774188935757, -0.0120676439255476, -0.005099371075630188, -0.0080600306391716, 0.014079704880714417, -0.0020367265678942204, -0.008362890221178532, -0.001621987670660019, 0.010619360022246838, 0.013944074511528015, 0.0009812230709940195, 0.01836475357413292, 0.00273580988869071, -0.008425148203969002, -0.009124254807829857, 0.00011686794459819794, 0.0009999654721468687, 0.015176774933934212, -0.0009844052838161588, 0.013951435685157776, 0.004029604606330395, 0.006666754838079214, 0.003529589157551527, 0.003615013789385557, -0.02800256945192814, 0.006249892991036177, -0.008050324395298958, 0.005056394264101982, -0.006130233872681856, 0.006157447583973408, -0.010642053559422493, 0.0012126392684876919, -0.006806216202676296, 0.004176209215074778, -0.006571719888597727, -0.009268700145184994, -0.0075151631608605385, -0.0015292258467525244, -0.010599321685731411, 0.003558061085641384, 0.007374519016593695, 0.003586599137634039, 0.017905788496136665, 0.008015276864171028, -0.009034614078700542, 0.0018911826191470027, -0.005265430081635714, 0.004869093652814627, -0.0001151503311120905, -0.003885870799422264, 0.004713456612080336, 0.005261662881821394, -0.006401803344488144, 0.004026818089187145, 0.000506703567225486, 0.01196456328034401, -0.007442399859428406, 0.007578311488032341, 0.011165248230099678, -0.0009072477114386857, 0.010882778093218803, -0.0029303899500519037, 0.0024887293111532927, 0.004268537741154432, -0.003925780300050974, 0.01125251967459917, 0.0056076375767588615, 0.0013249896001070738, -0.0064854929223656654, 0.008991091512143612, 0.006860945839434862, 0.01103312149643898, 0.009761952795088291, -0.010707248002290726, -0.013999280519783497, 0.00729756522923708, -0.011525528505444527, 0.007183250039815903, 0.020575670525431633, -0.0008294707513414323, 0.002093465067446232, 0.005759619176387787, -0.0024755089543759823, 0.006597691681236029, 0.01883961632847786, -0.0017893409822136164, 0.004597699735313654, 0.0020806791726499796, -0.016394654288887978, 0.00436061155050993, -0.0021841854322701693, -0.01360281091183424, 0.0053757247515022755, 0.0006083177286200225, 0.0009018208365887403, 0.023406485095620155, -0.0009405831224285066, 0.018612656742334366, 0.0033334933687001467, -0.003511708928272128, -0.0026272705290466547, -0.0007344239274971187, 0.00568321393802762, -0.0053346729837358, -0.0017605028115212917, -0.010383752174675465, 0.018871944397687912, 0.0006560813635587692, -0.010139352641999722, 0.0026594139635562897, -0.0033114543184638023, 0.017703739926218987, -0.00698117958381772, -0.0020041917450726032, -0.004826934076845646, 0.0005630375235341489, 0.0032594038639217615, -0.0009713696199469268, -0.008052065037190914, -0.0027339174412190914, -0.010677228681743145, 0.004025970585644245, -0.012248994782567024, 0.015234006568789482, -0.005934533197432756, 0.01589520275592804, -0.012386002577841282, 0.009487216360867023, -0.0009444615570828319, 0.0125525938346982, -0.0013922285288572311, 0.013387584127485752, 0.0037463558837771416, -0.007817583158612251, 0.01384445745497942, -0.005437555257230997, -0.0015223644440993667, -0.015931112691760063, -0.010777517221868038, 0.02394471876323223, 0.011097057722508907, 0.010094624944031239, 0.012511318549513817, 0.0038457082118839025, 0.009449491277337074, 0.005493646953254938, 0.011773099191486835, 0.0019221196416765451, -0.013554790988564491, 0.01794261485338211, -0.0231052003800869, 0.008189410902559757, 0.006517274770885706, -0.004495919682085514, 0.001762248226441443, 0.008912311866879463, 0.009711232967674732, -0.00761059345677495, 0.02114887163043022]


class SpecAugment(nn.Module):
    """
    Zeroes out(cuts) random continuous horisontal or
    vertical segments of the spectrogram as described in
    SpecAugment (https://arxiv.org/abs/1904.08779).

    params:
    freq_masks - how many frequency segments should be cut
    time_masks - how many time segments should be cut
    freq_width - maximum number of frequencies to be cut in one segment
    time_width - maximum number of time steps to be cut in one segment.
        Can be a positive integer or a float value in the range [0, 1].
        If positive integer value, defines maximum number of time steps
        to be cut in one segment.
        If a float value, defines maximum percentage of timesteps that
        are cut adaptively.
    """

    def __init__(
        self, freq_masks=0, time_masks=0, freq_width=10, time_width=10, max_time_masks=20, gauss_mask_std=0.0, rng=None,
    ):
        super(SpecAugment, self).__init__()

        self._rng = random.Random() if rng is None else rng

        self.freq_masks = freq_masks
        self.time_masks = time_masks
        self.max_time_masks = max_time_masks

        self.freq_width = freq_width
        self.time_width = time_width

        self.gauss_mask_std = gauss_mask_std

        if isinstance(time_width, int):
            self.adaptive_temporal_width = False
        else:
            if time_width > 1.0 or time_width < 0.0:
                raise ValueError('If `time_width` is a float value, must be in range [0, 1]')

            self.adaptive_temporal_width = True

        if isinstance(time_masks, int):
            self.adaptive_time_mask = False
        else:
            if time_masks >= 1.0 or time_masks < 0.0:
                raise ValueError('If `time_width` is a float value, must be in range [0, 1]')

            self.adaptive_time_mask = True

    @torch.no_grad()
    def forward(self, x, length):
        B, D, T = x.shape

        for idx in range(B):
            for _ in range(self.freq_masks):
                x_left = self._rng.randint(0, D - self.freq_width)

                w = self._rng.randint(0, self.freq_width)

                x[idx, x_left : x_left + w, :] = 0.0

            if self.adaptive_temporal_width:
                time_width = max(1, int(length[idx] * self.time_width))
            else:
                time_width = self.time_width

            if self.adaptive_time_mask:
                time_masks = int(length[idx] * self.time_masks)
                time_masks = min(time_masks, self.max_time_masks)
            else:
                time_masks = self.time_masks

            for _ in range(time_masks):
                y_left = self._rng.randint(0, length[idx] - time_width)

                w = self._rng.randint(0, time_width)

                if self.gauss_mask_std == 0:
                    x[idx, :, y_left:y_left + w] = 0.0
                else:
                    x[idx, :, y_left:y_left + w] = torch.normal(mean=0, std=self.gauss_mask_std, size=(D, w)).to(x.device)

        return x


class SpecCutout(nn.Module):
    """
    Zeroes out(cuts) random rectangles in the spectrogram
    as described in (https://arxiv.org/abs/1708.04552).

    params:
    rect_masks - how many rectangular masks should be cut
    rect_freq - maximum size of cut rectangles along the frequency dimension
    rect_time - maximum size of cut rectangles along the time dimension
    """

    def __init__(self, rect_masks=0, rect_time=5, rect_freq=20, rng=None):
        super(SpecCutout, self).__init__()

        self._rng = random.Random() if rng is None else rng

        self.rect_masks = rect_masks
        self.rect_time = rect_time
        self.rect_freq = rect_freq

    @torch.no_grad()
    def forward(self, x):
        sh = x.shape

        for idx in range(sh[0]):
            for i in range(self.rect_masks):
                rect_x = self._rng.randint(0, sh[1] - self.rect_freq)
                rect_y = self._rng.randint(0, sh[2] - self.rect_time)

                w_x = self._rng.randint(0, self.rect_time)
                w_y = self._rng.randint(0, self.rect_freq)

                x[idx, rect_x : rect_x + w_x, rect_y : rect_y + w_y] = 0.0

        return x
